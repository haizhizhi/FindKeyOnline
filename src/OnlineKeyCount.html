<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ç½‘é¡µå…³é”®å­—æŸ¥è¯¢</title>
    <!--<script src="http://code.jquery.com/jquery-1.9.1.min.js" type="text/javascript"></script>-->
    <style>
        tr,table,td,th {
            border: 1px solid grey;
        }
        table{
            border: 1px solid grey;
            width:100%;
        }
    </style>
    <script>
        //å¾—åˆ°ç»“æœä¸´æ—¶è¡¨å¹¶æ’åº
        var temp_result=[];

        //è¯»å–æ–‡ä»¶
        function getCount()
        {
            var file=document.getElementById("file");
            var reader =new FileReader();
            reader.readAsText(file.files[0],"GBK");
            // document.getElementById("scrollText").innerText="æ­£åœ¨è¯»å–æ–‡ä»¶å“¦ğŸ˜‚ğŸ˜‚";
            reader.onload=function(){
                // document.getElementById("scrollText").innerText="è¯»å–æ–‡ä»¶å®ŒæˆğŸ™ƒğŸ™ƒğŸ™ƒğŸ™ƒ";
                analysis(this.result);
            }
            reader.onloadend=function(){
                document.getElementById("progress1").setAttribute("max",temp_result.length.toString());
                document.getElementById("totalNum").innerText=temp_result.length.toString();
                document.getElementById("countNum").innerText="0";
                document.getElementById("progress2").style.display="block";
                start(temp_result);
            }
        }
        //è§£ææ–‡ä»¶
        function analysis(str){
            // document.getElementById("scrollText").innerText="æ­£åœ¨ç»Ÿè®¡è¯·ç¨ç­‰å“¦ğŸ˜¯ğŸ˜¯";
            var rows=str.split(/\s+/);
            for(var i=0;i<rows.length;i++){
                if(rows[i].trim()==""){
                    continue;
                }
                var line=rows[i].split(",");
                var num=line[0];
                var url=line[1];
                var key=line[2];
                appendHtml(num,url,key,"æ•¬è¯·æœŸå¾…","ç­‰å¾…ä¸­ã€‚ã€‚ã€‚","å“åº”ä¸­ã€‚ã€‚ã€‚");
                temp_result.push({
                    num:num,
                    url:url,
                    key:key
                });
            }
        }

        // function pushTempArray(num,url,key,count){
        //     var lineObject={
        //         num:num,
        //         url:url,
        //         key:key,
        //         count:count
        //     };
        //     temp_result.push(lineObject);
        // }
        // //æ’åºä¸´æ—¶è¡¨
        // function sortArray(array){
        //     array.sort(
        //         function(object1,object2){
        //             if(object1["num"]>object2["num"]){
        //                 return 1;
        //             }else if(object1["num"]<object2["num"]){
        //                 return -1;
        //             }else{
        //                 return 0;
        //             }
        //         }
        //     );
        // }

        // function showResult(){
        //     sortArray(temp_result);
        //     for(var i=0;i<temp_result.length;i++){
        //         appendHtml(temp_result[i]["num"],temp_result[i]["url"],temp_result[i]["key"],temp_result[i]["count"]);
        //     }
        // }
        //ç»Ÿè®¡é“¾æ¥è®¿é—®çš„æ¬¡æ•°
        // var postCount=0;
        //è®¡ç®—URLè¿”å›çš„HTMLåŒ…å«çš„å…³é”®å­—
        var time=0;
        function count(num,url,key){
            var result={};
            var xhr = new XMLHttpRequest();
            xhr.open('get', url, true);
            xhr.dataType="html";
            xhr.send();
            xhr.onreadystatechange=function() {
                if (xhr.readyState == 4) {
                    time++;
                    if (xhr.status == 200) {
                        var count=countNumber(this.responseText,key);
                        // var keyWord=undefined;
                        // var progressBar=undefined;
                        // pushTempArray(num,url,key,count);
                        // appendHtml(url,key,count);
                        result={
                            num:num,
                            count:count,
                            status:xhr.status
                        };
                    }else{
                        // if(postCount<=20){
                        //     // postAgain(num,url,key);
                        //     // postCount++;
                        // }else{
                        //     postCount=0;
                        //     // pushTempArray(num,url,key,"è¯·æ±‚å¼‚å¸¸");
                        //     // appendHtml(num,url,key,"è¯·æ±‚å¼‚å¸¸");
                        // }
                        result={
                            num:num,
                            count:"ç¬¬äºŒé˜¶æ®µå¼‚å¸¸",
                            status:xhr.status
                        };
                    }
                }else{
                    result={
                        num:num,
                        count:"ç¬¬ä¸€é˜¶æ®µå¼‚å¸¸",
                        status:xhr.readyState
                    };
                }
                document.getElementById("progress1").setAttribute("value",time.toString());
                document.getElementById("countNum").innerText=time.toString();
                document.querySelector(".tr"+num).childNodes[4].innerHTML=result["count"];
                document.querySelector(".tr"+num).childNodes[5].innerHTML=result["status"];
            }
        }
        //å¼€å§‹ç»Ÿè®¡
        var basisCount=10;
        function start(temp_result){
            // document.getElementById("scrollText").innerText="å¼€å§‹ç»Ÿè®¡ã€‚ã€‚ğŸ™ƒğŸ™ƒğŸ™ƒğŸ™ƒ";
            for(var i=0;i<basisCount;i++){
                var num=temp_result[0]["num"];
                var url=temp_result[0]["url"];
                var key=temp_result[0]["key"];
                count(num,url,key);
                // temp_result.pop();
                temp_result.shift();
                if(temp_result.length==0){
                    // document.getElementById("scrollText").innerText="æ–‡ä»¶ç»Ÿè®¡å®ŒæˆğŸ™ƒğŸ™ƒğŸ™ƒğŸ™ƒ";
                    return;
                }
            }

            if(temp_result.length!=0&&time%10==0){
                start(temp_result);
            }
        }

        //è®¡ç®—å­—ç¬¦ä¸²ä¸­åŒ…å«çš„å…³é”®å­—
        function countNumber(str,key){
            var reg=new RegExp(key,"ig");
            var result=str.match(reg);
            if(result==undefined){
                return 0;
            }else{
                return result.length;
            }
        }
        //ç”ŸæˆæŸ¥è¯¢çš„è¡¨æ ¼
        function appendHtml(num,url,key,progress,count,statusCode){
            var table=document.getElementById("tableContent");
            var tr=document.createElement("tr");
            tr.setAttribute("class","tr"+num);
            tr.setAttribute("name","row");
            table.appendChild(tr);
            for(var i=0;i<arguments.length;i++){
                var td=document.createElement("td");
                td.innerText=arguments[i];
                tr.appendChild(td);
            }
        }
        //æ¸…ç©ºæŸ¥è¯¢åˆ—è¡¨
        function clearTable(){
            var nodes=document.getElementsByName("row");
            for(var i=nodes.length-1;i>=0;i--){
                nodes[i].remove();
            }
            temp_result=[];
            time=0;
            document.getElementById("progress2").style.display="none";
            document.getElementById("progress1").setAttribute("value","0");
            // document.getElementById("scrollText").innerText="å•¦å•¦å•¦å•¦å•¦å•¦å•¦å•¦ğŸ˜ğŸ˜ğŸ˜ğŸ˜";
        }

        var columnDelimiter = ","; //åˆ—åˆ†å‰²ç¬¦
        var lineDelimiter = "\n";  //è¡Œåˆ†å‰²ç¬¦
        //ä¸‹è½½æŸ¥è¯¢ç»“æœ
        function downLoad(){
            var trs = document.getElementsByName("row");
            var result = '';
            for(var i=0, l=trs.length; i<l; i++){
                var tds = trs[i].getElementsByTagName('td');
                for(var j=0, l2=tds.length; j<l2; j++){
                    result += tds[j].innerHTML + columnDelimiter;
                }
                result += lineDelimiter;
            }
            result = "\ufeff" + result;
            var blob = new Blob([result], {type: 'text/csv;charset=UTF-8;'});
            var downloadLink = document.createElement("a");
            if ('download' in downloadLink) {
                var url = URL.createObjectURL(blob);
                downloadLink.href = url;
                downloadLink.download = "result.csv";
                downloadLink.hidden = true;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            }else{
                if(navigator.msSaveBlob){
                    navigator.msSaveBlob(blob, "result.csv");
                }
            }
        }

        // //ä¸ºæŸ¥è¯¢ç»“æœæ’åº
        // function sortResult(){
        //     var result=[];
        //     var trs = document.getElementsByName("row");
        //     for(var i=0, l=trs.length; i<l; i++){
        //         var tds = trs[i].getElementsByTagName('td');
        //         for(var j=0, l2=tds.length; j<l2; j++){
        //
        //         }
        //         result += lineDelimiter;
        //     }
        // }
    </script>
    </head>
<body>
<div>

</div>
<DIV style="float:left;width:38%;">
    <diV style="float:left;">
        <INPUT id="file" type="file" />
    </diV>
    <div style="float:RIGHT;">
        <button onclick="getCount()">å¼€å§‹ç»Ÿè®¡</button>
        <button onclick="downLoad()">ä¸‹è½½ç»“æœ</button>
        <button onclick="clearTable()" style="margin-right:0px;">æ¸…ç©ºæŸ¥è¯¢åˆ—è¡¨</button>
        <!--<button>ä¸‹è½½</button>-->
    </div>
</DIV>
<!--<DIV style="float:left;width:61%;">-->
    <!--<marquee id="scrollText" behavior=alternate scrollamount=10 direction=right>å•¦å•¦å•¦å•¦å•¦å•¦å•¦å•¦ğŸ˜ğŸ˜ğŸ˜ğŸ˜</marquee>-->
<!--</DIV>-->
<DIV style="float:left;width:61%;">
    <progress id ="progress1" style="width:100%;-webkit-appearance:none;margin-left:12px;" value="0" max="100">
    </progress>
    <DIV id="progress2" style="position:relative;font-size:12px;top:-19px;left:430px;display: none;">
        <span id="countNum"></span>
        <span>/</span>
        <span id="totalNum"></span>
    </DIV>
</DIV>
<table id="tableContent">
    <tr>
        <th>ç¼–å·</th>
        <th>é“¾æ¥</th>
        <th>å…³é”®å­—</th>
        <th>è¿›åº¦æ¡</th>
        <th>ç»Ÿè®¡</th>
        <th>çŠ¶æ€ç </th>
    </tr>
</table>
</body>

</html>